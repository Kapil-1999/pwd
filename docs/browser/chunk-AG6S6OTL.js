import{a as xe}from"./chunk-CYXIDJUQ.js";import{$a as ye,A as W,B as p,E as U,Ha as K,K as l,L as c,M as u,P as le,Pa as he,Q as _,Qa as fe,R as Z,Sa as ve,Va as Ce,Wa as _e,X as k,Y as B,Z as ce,_a as Me,a as Y,ab as be,b as q,bb as we,c as Q,d as z,eb as Le,f as X,fb as Ie,g as ee,h as te,i as ie,j as x,ja as G,k as ne,ka as R,l as E,lb as De,m as oe,ma as pe,n as F,o as re,oa as de,ob as ke,p as y,pa as me,pb as Oe,q as V,r as ae,s as L,t as I,ta as ue,u as D,ua as ge,v as se,x as a,y as h}from"./chunk-XSDZE57B.js";import"./chunk-7RV22KDK.js";import{a as $e}from"./chunk-7GML436D.js";import{a as j,b as A,g as Ne,i as J}from"./chunk-P2VZOJAX.js";var d=Ne($e());var Pe=(()=>{class n{constructor(e){this.apiService=e}liveTracking(e){let t=[];e.selectedDesigId!==void 0&&t.push(`selectedDesigId=${e.selectedDesigId}`),e.zoneId!==void 0&&t.push(`zoneId=${e.zoneId}`),e.circleId!==void 0&&t.push(`circleId=${e.circleId}`),e.districtId!==void 0&&t.push(`districtId=${e.districtId}`);let i=`${ye.liveTracking.split("?")[0]}?${t.join("&")}`;return this.apiService.get(i).pipe(te(o=>z(o)))}static{this.\u0275fac=function(t){return new(t||n)(re(be))}}static{this.\u0275prov=oe({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();function Ae(n,P){n&1&&u(0,"app-loader")}function We(n,P){if(n&1&&(l(0,"li",26)(1,"span"),k(2),c(),l(3,"span"),k(4),c(),l(5,"span",27),u(6,"i",28),c()()),n&2){let e=P.$implicit,t=Z(2);a(),U(t.getVehicleColor(e)),a(),B(e==null?null:e.full_name),a(),U(t.getVehicleColor(e)),a(),B(t.formatVehicleStatusDuration(e)),a(),U(t.getVehicleColor(e))}}function Ze(n,P){if(n&1&&(l(0,"ul",24),W(1,We,7,8,"li",25),G(2,"searchFilter"),c()),n&2){let e=Z();a(),p("ngForOf",R(2,1,e.userData,e.searchKeyword))}}function Be(n,P){n&1&&(l(0,"ul",24)(1,"li",29)(2,"span",30),k(3,"No Data Available"),c()()())}var Se=(()=>{class n{constructor(e,t){this.commonService=e,this.fb=t,this.mapData=new D,this.selectUserConfirm=new D,this.loginUser=null,this.zoneList=[],this.circleList=[],this.cityList=[],this.config={displayKey:"text",search:!0,height:"300px",placeholder:"Select Zone"},this.config1=A(j({},this.config),{placeholder:"Select Circle"}),this.config2=A(j({},this.config),{placeholder:"Select City"})}ngOnInit(){this.initializeForm(),this.getUserDetails(),this.getZoneData()}initializeForm(){this.liveForm=this.fb.group({zone:[null],circle:[null],city:[null]})}ngOnChanges(e){this.userData=this.userValue,this.swiperList=this.userCountData}getUserDetails(){let e=this.commonService.getUserDetails();this.loginUser=e?.full_name||null}emitMapData(){this.mapData.emit({zone:this.liveForm.get("zone")?.value,circle:this.liveForm.get("circle")?.value,city:this.liveForm.get("city")?.value})}getZoneData(){this.commonService.zoneList(30).subscribe({next:e=>{this.zoneList=e?.body?.result||[],this.zoneList.length===1?(this.liveForm.controls.zone.setValue(this.zoneList[0]),this.getCircleData(this.zoneList[0].value)):this.resetForm(["zone","circle","city"]),this.emitMapData()},error:e=>console.error("Error fetching zones:",e)})}onChangeZone(e){e?.value?.value?this.getCircleData(e.value.value):this.resetForm(["circle","city"]),this.emitMapData()}getCircleData(e){this.commonService.circleList(e).subscribe({next:t=>{this.circleList=t?.body?.result||[],this.circleList.length===1?(this.liveForm.controls.circle.setValue(this.circleList[0]),this.getCityData(this.circleList[0].value)):this.resetForm(["circle","city"]),this.emitMapData()},error:t=>console.error("Error fetching circles:",t)})}onChangeCircle(e){e?.value?.value?this.getCityData(e.value.value):this.resetForm(["city"]),this.emitMapData()}onChangeCity(e){this.emitMapData()}getCityData(e){this.commonService.cityList(e).subscribe({next:t=>{this.cityList=t?.body?.result||[],this.cityList.length===1&&this.liveForm.controls.city.setValue(this.cityList[0]),this.emitMapData()},error:t=>console.error("Error fetching cities:",t)})}resetForm(e){e.forEach(t=>{this.liveForm.controls[t]?.setValue(null)}),e.includes("circle")&&(this.circleList=[]),e.includes("city")&&(this.cityList=[])}getVehicleColor(e){return e?.status_duration==="Never Connected!"?"status-0":"status"}formatVehicleStatusDuration(e){return e.status_duration.split(" ")[0]==="Never"?`${e.status_duration}`:`${e.status_duration}`}confirm(e){this.userData=[],this.userData=e?.data,this.selectUserConfirm.emit(e?.data)}static{this.\u0275fac=function(t){return new(t||n)(h(xe),h(Me))}}static{this.\u0275cmp=y({type:n,selectors:[["user-in-map"]],inputs:{userValue:"userValue",userCountData:"userCountData",spinnerLoading:"spinnerLoading"},outputs:{mapData:"mapData",selectUserConfirm:"selectUserConfirm"},features:[ae],decls:27,vars:15,consts:[["card",""],["vehicleFollowWrapper",""],[1,"card"],[1,"card-content"],[1,"vehclelist"],[1,"label"],[1,"login-user",2,"text-transform","capitalize"],["aria-hidden","true",1,"fa","fa-user-circle-o"],[1,"right"],[1,"tab-value"],[3,"formGroup"],[1,"searcharea","mt-2"],[1,"zone"],["formControlName","zone",3,"change","config","options"],[1,"circle"],["formControlName","circle",3,"change","config","options"],[1,"city"],["formControlName","city",3,"change","config","options"],[1,"swiper-data","mt-3"],[3,"onConfirm","vehicleStauts"],[1,"vehicle-follow-wrapper","mt-3"],[1,"vehicle-follow"],[4,"ngIf"],["class","vehicle-data",4,"ngIf"],[1,"vehicle-data"],["class","vehicle-value","style","cursor: pointer; ",4,"ngFor","ngForOf"],[1,"vehicle-value",2,"cursor","pointer"],[2,"text-align","end"],["aria-hidden","true",1,"fa","fa-circle"],[1,"vehicle-value",2,"text-align","center"],[2,"color","black","width","100% !important"]],template:function(t,i){if(t&1){let o=le();l(0,"div",2,0)(2,"div",3)(3,"div",4)(4,"div",5)(5,"span",6),u(6,"i",7),k(7),c()(),u(8,"div",8),c(),l(9,"div",9)(10,"form",10)(11,"div",11)(12,"div",12)(13,"ngx-select-dropdown",13),_("change",function(r){return L(o),I(i.onChangeZone(r))}),c()(),l(14,"div",14)(15,"ngx-select-dropdown",15),_("change",function(r){return L(o),I(i.onChangeCircle(r))}),c()(),l(16,"div",16)(17,"ngx-select-dropdown",17),_("change",function(r){return L(o),I(i.onChangeCity(r))}),c()()()(),l(18,"div",18)(19,"swiper",19),_("onConfirm",function(r){return L(o),I(i.confirm(r))}),c()(),l(20,"div",20,1)(22,"div",21),W(23,Ae,1,0,"app-loader",22)(24,Ze,3,4,"ul",23)(25,Be,4,0,"ul",23),G(26,"searchFilter"),c()()()()()}if(t&2){let o;a(7),ce(" ",i.loginUser," "),a(3),p("formGroup",i.liveForm),a(3),p("config",i.config)("options",i.zoneList),a(2),p("config",i.config1)("options",i.circleList),a(2),p("config",i.config2)("options",i.cityList),a(2),p("vehicleStauts",i.swiperList),a(4),p("ngIf",i.spinnerLoading),a(),p("ngIf",!i.spinnerLoading&&i.userData&&i.userData.length>0),a(),p("ngIf",!i.userData||i.userData.length==0||i.userData==null||!((o=R(26,12,i.userData,i.searchKeyword))!=null&&o.length))}},dependencies:[de,me,De,ve,he,fe,Ce,_e,ke,Le,Ie],styles:[".card[_ngcontent-%COMP%]{position:absolute;width:450px;top:10px;left:10px;margin-bottom:0;border-radius:10px;box-shadow:0 4px 8px #0000001a}.tab-value[_ngcontent-%COMP%]{height:auto;display:flex;flex-direction:column}.card-content[_ngcontent-%COMP%]{padding:15px;color:#fff;transition:max-height .5s ease-out;flex-grow:1;display:flex;flex-direction:column}.card-content[_ngcontent-%COMP%]   .vehclelist[_ngcontent-%COMP%]{display:flex;justify-content:space-between}.card-content[_ngcontent-%COMP%]   .vehclelist[_ngcontent-%COMP%]   .login-user[_ngcontent-%COMP%]{border:2px solid white;border-radius:10px;padding:5px 15px;color:#000}.card-content[_ngcontent-%COMP%]   .vehclelist[_ngcontent-%COMP%]   .label[_ngcontent-%COMP%]{font-weight:700}.card-content[_ngcontent-%COMP%]   .vehclelist[_ngcontent-%COMP%]   .label[_ngcontent-%COMP%]   i.fa.fa-circle[_ngcontent-%COMP%]{color:green;margin-left:-13px}.card-content[_ngcontent-%COMP%]   .vehclelist[_ngcontent-%COMP%]   .right[_ngcontent-%COMP%]{display:flex;justify-content:space-between;gap:10px}.card-content[_ngcontent-%COMP%]   .vehclelist[_ngcontent-%COMP%]   .right[_ngcontent-%COMP%]   .searchcontent[_ngcontent-%COMP%]{display:flex;justify-content:space-between;gap:5px}.card-content[_ngcontent-%COMP%]   .vehclelist[_ngcontent-%COMP%]   .arrow[_ngcontent-%COMP%]{cursor:pointer;width:20px;height:20px;background-image:url(/assets/icons/down-new.png);background-size:contain;background-repeat:no-repeat}.card-content[_ngcontent-%COMP%]   .searcharea[_ngcontent-%COMP%]{display:grid;gap:3px;grid-template-columns:5fr 5fr 5fr}.card-content[_ngcontent-%COMP%]   .vehicle-follow[_ngcontent-%COMP%]{background:#f8f8ff;border-radius:0 0 10px 10px;border-style:solid;border-color:#e4e4e4;border-width:1px;overflow:auto;flex-grow:1;margin-top:auto}.card-content[_ngcontent-%COMP%]   .vehicle-follow[_ngcontent-%COMP%]   ul.vehicle-data[_ngcontent-%COMP%]{width:100%}.card-content[_ngcontent-%COMP%]   .vehicle-follow[_ngcontent-%COMP%]   ul.vehicle-data[_ngcontent-%COMP%]   .vehicle-value[_ngcontent-%COMP%]{display:grid;grid-template-columns:4fr 4fr 2fr;border-bottom:1px solid #d3c2c2;padding:8px;align-items:center}.card-content[_ngcontent-%COMP%]   .vehicle-follow[_ngcontent-%COMP%]   ul.vehicle-data[_ngcontent-%COMP%]   .vehicle-value[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:14px;line-height:14.52px;padding-left:10px}.status-0[_ngcontent-%COMP%]{color:#414141!important}.status[_ngcontent-%COMP%]{color:#19ad00!important}span.login-user[_ngcontent-%COMP%]{font-size:16px;font-weight:600}.vehicle-follow-wrapper[_ngcontent-%COMP%]{overflow:auto;max-height:calc(100vh - 300px);box-shadow:0 9px 9px #00000040;border-radius:12px;scrollbar-width:thin}"]})}}return n})();var Te=(()=>{class n{constructor(e,t,i,o){this.platformId=e,this.liveSrevice=t,this.storageService=i,this.cdr=o,this.onConfirm=new D,this.livePayloadValue={selectedDesigId:0,zoneId:null,circleId:null,districtId:null},this.spinnerLoading=!1,this.counter=10,this.counterInterval=null,this.destroy$=new Y,this.markers=[],this.infoVehicleWindows=[],this.clickedMarker=null}ngOnInit(){ge(this.platformId)&&this.initializeMap()}initializeMap(){return J(this,null,function*(){let t=(yield import("./chunk-64NQCRD3.js")).default;this.map=t.map("map_canvas",{center:[28.6139,77.2088],zoom:6});let i=document.getElementById("map_canvas");i&&(i.style.zIndex="100");let o=t.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors",maxZoom:21}),s=t.tileLayer("http://www.google.cn/maps/vt?lyrs=s@189&gl=cn&x={x}&y={y}&z={z}",{attribution:'Imagery \xA9 <a href="http://maps.google.com">Google</a>',maxZoom:21}),f={"Google Map":t.tileLayer("http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{maxZoom:21,subdomains:["mt0","mt1","mt2","mt3"],attribution:"&copy; Google Maps"}).addTo(this.map),OpenStreetMap:o,Satellite:s};t.control.layers(f).addTo(this.map)})}confirm(e){let t=Array.isArray(e.zone)&&e.zone.length===0?null:e.zone?.value,i=Array.isArray(e.circle)&&e.circle.length===0?null:e.circle?.value,o=Array.isArray(e.city)&&e.city.length===0?null:e.city?.value,s={selectedDesigId:0,zoneId:t,circleId:i,districtId:o};this.livePayloadValue=Object.fromEntries(Object.entries(s).filter(([r,f])=>f!==null)),this.getLiveTracking()}ngOnDestroy(){this.subscription&&this.subscription.unsubscribe()}getLiveTracking(){this.spinnerLoading=!0,this.subscription&&this.subscription.unsubscribe(),this.subscription=X(0,1e4).pipe(E(e=>{this.countdown=e%10===0?0:10-e%10,this.counter=10,clearInterval(this.counterInterval),this.counterInterval=setInterval(()=>{this.counter--},1e3)}),x(()=>this.liveSrevice.liveTracking(this.livePayloadValue)),E(e=>{this.spinnerLoading=!1,this.data=e?.body?.result||[],this.userCountData=e?.body?.result||[]}),x(()=>this.storageService.getItem("status")),E(e=>{this.selectedStatus=e,this.filterout(this.data),this.onConfirm.emit(!0),this.plotVehicleonMap()})).subscribe(()=>{},e=>{console.error("Error fetching vehicle data:",e),this.spinnerLoading=!1})}filterout(e){return this.selectedStatus==="Admin"?this.userData=e.filter(t=>t?.designation_id==1):this.selectedStatus==="CE"?this.userData=e.filter(t=>t?.designation_id==2):this.selectedStatus==="SE"?this.userData=e.filter(t=>t?.designation_id==3):this.selectedStatus==="EE"?this.userData=e.filter(t=>t?.designation_id==4):this.selectedStatus==="AE"?this.userData=e.filter(t=>t?.designation_id==5):this.selectedStatus==="JE"?this.userData=e.filter(t=>t?.designation_id==6):(this.selectedStatus==="All"||this.selectedStatus==null||this.selectedStatus==null)&&(this.userData=e),this.userOnMapdata=this.userData,z(this.userOnMapdata)}plotVehicleonMap(){if(this.liveData)return;Q(this.userOnMapdata).pipe(x((t,i)=>{if(!t||!t?.latitude&&!t?.longitude)return q;let o=this.findExistingMarkerIndex(t.full_name),s,r;o!==-1&&(s=this.markers[o].getLatLng().lat,r=this.markers[o].getLatLng().lng);let f=t?.latitude,b=t?.longitude,Fe=f-s,Ve=b-r,H=Math.atan2(Ve,Fe)*(180/Math.PI),S=document.createElement("canvas"),M=S.getContext("2d"),m=new Image;return m.src=this.onCheckVehicleDevice(t),new Promise(N=>{m.onload=()=>{let g=Math.max(m.width,m.height),v=g;S.width=g,S.height=v,M.clearRect(0,0,g,v),M.translate(g/2,v/2),M.rotate(H*Math.PI/180),M.drawImage(m,-m.width/2,-m.height/2,m.width,m.height),M.rotate(-H*Math.PI/180),M.translate(-g/2,-v/2);let T=d.icon({iconUrl:S.toDataURL(),iconSize:[40,40],iconAnchor:[20,20]}),C=d.latLng(t?.latitude,t?.longitude);N({user:t,icon:T,newPosition:C,existingMarkerIndex:o})}}).then(N=>{let{vehicle:g,icon:v,newPosition:T,existingMarkerIndex:C}=N;if(C!==-1){this.markers[C].setIcon(v),this.markers[C].setLatLng(T);let w=this.infoVehicleWindows[C];if(w&&this.clickedMarker===this.markers[C]){let Ue=this.clickedMarker.getTooltip().getContent();if(this.userOnMapdata.find($=>$?.full_name===Ue)){let $=this.generateInfoWindowContent(g);w.setContent($).setLatLng(T)}}}else{let w=d.popup();this.createMarker(g,i,v,w),this.infoVehicleWindows.push(w)}return Promise.resolve()})}),x(()=>ee(1e4).pipe(ne(this.destroy$))),ie(1)).subscribe(()=>{this.cdr.detectChanges()})}findExistingMarkerIndex(e){return this.markers.findIndex(t=>t.getTooltip()?.getContent()===e)}onCheckVehicleDevice(e){return"assets/images/rp_marker_person_red.png"}createMarker(e,t,i,o){let s=d.latLng(e?.latitude,e?.longitude),r=d.marker(s,{icon:i}).addTo(this.map);r.bindTooltip(`${e?.full_name}`,{direction:"bottom",className:"map-label",permanent:!0}),r.popupManuallyClosed=!1,o.on("close",()=>{r.popupManuallyClosed=!0}),r.on("click",()=>{r.popupManuallyClosed&&(r.openPopup(),r.popupManuallyClosed=!1),this.clickedMarker=r;let b=this.generateInfoWindowContent(e);o.setContent(b).setLatLng(s).openOn(this.map)}),this.markers.push(r);let f=d.latLngBounds(this.markers.map(b=>b.getLatLng()));this.map.fitBounds(f)}generateInfoWindowContent(e){return`
      <div>
        <div class="live-data pl-2 mt-1">
          <div class="row mb-2">
            <div class="col-md-7">
              <span style="font-size:16px" class="label">
                <strong>${e?.full_name||"N/A"}</strong>
              </span>
            </div>
            <div class="col-md-5">
              <span>
                <strong>Designation:</strong> ${e?.designation_name||"N/A"}
              </span>
            </div>
          </div>  
          <div class="row mb-2">
            <div class="col-md-7">
              <span>
                <strong>Date:</strong> ${e?.time_stamp||"N/A"}
              </span>
            </div>
            <div class="col-md-5">
              <span>
                <strong>Status:</strong> ${e?.status_duration||"N/A"}
              </span>
            </div>
          </div>  
          <div class="row mb-2">
            <div class="col-md-7">
              <span>
                <strong>Speed:</strong> ${e?.speed||0} Km/H
              </span>
            </div>
            <div class="col-md-5">
              <span>
                <strong>Day Distance:</strong> ${e?.day_distance||0} Km
              </span>
            </div>
          </div>  
          <div class="row mb-2">
            <div class="col-md-7">
              <span>
                <strong>Contact No.:</strong> ${e?.mobile_no||"N/A"}
              </span>
            </div>
          </div>  
          <div class="row mb-2">
            <div class="col-md-12 location-part">
              <span style="color: black" class="label">
                ${e?.location||"Location not available"}
              </span>
            </div>
          </div>  
        </div>
      </div>`}selectUsersPlot(e){}static{this.\u0275fac=function(t){return new(t||n)(h(se),h(Pe),h(we),h(pe))}}static{this.\u0275cmp=y({type:n,selectors:[["live-map-tracking"]],outputs:{onConfirm:"onConfirm"},decls:7,vars:3,consts:[[1,"map-part"],[1,"map-container"],["id","map_canvas"],[1,"live"],[1,"main-content"],[1,"vehicle-list"],[3,"mapData","selectUserConfirm","userValue","userCountData","spinnerLoading"]],template:function(t,i){t&1&&(l(0,"div",0)(1,"div",1),u(2,"div",2)(3,"div",3),l(4,"div",4)(5,"div",5)(6,"user-in-map",6),_("mapData",function(s){return i.confirm(s)})("selectUserConfirm",function(s){return i.selectUsersPlot(s)}),c()()()()()),t&2&&(a(6),p("userValue",i.userData)("userCountData",i.userCountData)("spinnerLoading",i.spinnerLoading))},dependencies:[Se],styles:["[_ngcontent-%COMP%]:root{--color-red: #ce0e2d;--color-dark-gray: #383838;--color-light-black: #4c4d4b;--color-blue: #055989;--color-medium-black: #202020;--color-white: #fff;--color-light-gray: #f8f8f8;--color-medium-gray: #e8e8e8;--color-gray: #b1b1b1;--color-gray-b7: #b7b7b7;--color-dark-back: #000}.map-container[_ngcontent-%COMP%]{position:relative}div#over_map[_ngcontent-%COMP%]{flex:1 1 100%;align-items:center;position:absolute;background-color:#fff;top:15px;left:50%;display:flex;min-height:35px;z-index:99;width:50%;border:1px solid grey;border-radius:0 0 80px 80px;transform:translate(-50%,-50%);padding:0 20px}#map_canvas[_ngcontent-%COMP%]{position:absolute;inset:0;width:100%;border-radius:11px;height:calc(100vh - 54px);z-index:0!important}"]})}}return n})();var ze=(()=>{class n{static{this.\u0275fac=function(t){return new(t||n)}}static{this.\u0275cmp=y({type:n,selectors:[["app-manage-live-tracking"]],decls:1,vars:0,template:function(t,i){t&1&&u(0,"live-map-tracking")},dependencies:[Te]})}}return n})();var Ke=[{path:"track",component:ze}],Ee=(()=>{class n{static{this.\u0275fac=function(t){return new(t||n)}}static{this.\u0275mod=V({type:n})}static{this.\u0275inj=F({imports:[K.forChild(Ke),K]})}}return n})();var Tt=(()=>{class n{static{this.\u0275fac=function(t){return new(t||n)}}static{this.\u0275mod=V({type:n})}static{this.\u0275inj=F({imports:[ue,Ee,Oe]})}}return n})();export{Tt as LiveTrackingModule};
